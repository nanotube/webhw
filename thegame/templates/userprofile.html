{% extends "base.html" %}
{% load tag_extras %}

{% block title %}
User Profile
{% endblock %}

{% block content %}

<p>Welcome, {{ user.username }}. Your last login was at {{ user.last_login }}.</p>
<p>Your team members are: {{ user.get_profile.description }}</p>

{% if mastered_worlds_list %}
<div id="master">
    <h3>You are the master of the following worlds:</h3>
    {% for dict in world_and_user_list %}
        <p><a href="{{ dict.world.get_absolute_url }}master/">{{ dict.world.name }}</a>
        <ul>
            <li>Pending user applications: {{ dict.pending_users.count }}</li>
        </ul>
    {% endfor %}
</div>
{% endif %}

<!--
<a href="../worlds/"><h3>Your world memberships</h3></a>
-->
<h3>Your world memberships and statistics</h3>
<table>
{% for world in user_world_list %}
    <tr>
        <td  class="left">
            <a href="{{ world.get_absolute_url }}"><h3 class="section">{{ world.name }}</h3></a>
            <p>{% autoescape off %}{{ world.description }}{% endautoescape %}
            <table class="site">
                <tr>
                    <th>Period</th>
                    <th>Period status</th>
                    <th>Number of assets</th>
                    <th>Auctions won</th>
                    <th>Risk-free rate</th>
                    <th>Wealth created</th>
                </tr>
                {% for period in world.period_set.all %}
                    {% if period.is_ended %}
                        {{ period.calc_period_summary }}
                    {% endif %}
                    <tr class="{% cycle 'even' 'odd' %}">
                        <td class="left"><a href="{{ period.get_absolute_url }}" class="detail">{{ period.number }}: {{ period.name }}</a></td>
                        <td>{{ period.get_period_status }}</td>
                        <td>{{ period.asset_set.count }}</td>
                        <td>
                        {% if period.summary_completed %}
                            {% expr period.periodsummary_set.get(user = user).auctions_won %}
                        {% else %}
                            Period not yet complete.
                        {% endif %}
                        <td>{{ period.risk_free_rate|floatformat:4 }}%</td>
                        <td>
                        {% if period.summary_completed %}
                            {% expr period.periodsummary_set.get(user = user) as usersummary %}
                            <a href="{{ period.get_absolute_url }}period_results/">{{ usersummary.wealth_created|floatformat:2 }}</a>
                        {% else %}
                            Period not yet complete.
                        {% endif %}
                    </tr>
                {% endfor %}
            </table>
            <ul class="notes">
                <li>
                    Your current wealth in this world: 
                    {% expr user.get_profile().membership_set.get(world = world).wealth as world_wealth %}
                    {{ world_wealth|floatformat:2 }}
                </li>
                <li>Number of users in world: {{ world.membership_set.count }}</li>
                <li>Number of periods in world: {{ world.period_set.count }}</li>
            </ul>
        </td>
    </tr>
{% endfor %}
</table>



{% endblock %}
